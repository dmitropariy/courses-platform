@using System.Text.Json
@model courses_platform.Models.ViewModels.SubmissionSearchModel
@{
    ViewData["Title"] = "Пошук відповідей студентів";
}

<h2>Пошук відповідей студентів</h2>

<!-- React буде рендеритись сюди -->
<div id="searchApp"></div>

@section Scripts {
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        function SubmissionSearch({ initialModel, courses, assignmentTypes }) {
            const [dateFrom, setDateFrom] = useState(initialModel.DateFrom || '');
            const [dateTo, setDateTo] = useState(initialModel.DateTo || '');
            const [assignmentType, setAssignmentType] = useState(initialModel.AssignmentType || '');
            const [answerPrefix, setAnswerPrefix] = useState(initialModel.AnswerPrefix || '');
            const [answerSuffix, setAnswerSuffix] = useState(initialModel.AnswerSuffix || '');
            const [selectedCourses, setSelectedCourses] = useState(initialModel.SelectedCourseIds || []);
            const [results, setResults] = useState([]);
            const [totalCount, setTotalCount] = useState(0);
            const [loading, setLoading] = useState(false);

            const handleCourseChange = (e) => {
                const selected = Array.from(e.target.selectedOptions).map(o => o.value);
                setSelectedCourses(selected);
            };

            const search = async () => {
                setLoading(true);

                const formData = new FormData();
                formData.append('DateFrom', dateFrom);
                formData.append('DateTo', dateTo);
                formData.append('AssignmentType', assignmentType);
                formData.append('AnswerPrefix', answerPrefix);
                formData.append('AnswerSuffix', answerSuffix);
                selectedCourses.forEach(id => formData.append('SelectedCourseIds', id));

                const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
                formData.append('__RequestVerificationToken', token);

                try {
                    const res = await fetch('/Admin/SearchAjax', {
                        method: 'POST',
                        body: formData
                    });

                    if (!res.ok) {
                        console.error('HTTP error:', res.status, await res.text());
                        alert('Помилка сервера');
                        return;
                    }

                    const data = await res.json();
                    setResults(data);
                    setTotalCount(data.length);
                } catch (err) {
                    alert('Помилка при пошуку');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div>
                    <form onSubmit={(e) => { e.preventDefault(); search(); }} className="mb-4">
                        <div className="row g-3">
                            <div className="col-md-3">
                                <label className="form-label">Дата від</label>
                                <input type="datetime-local" className="form-control"
                                       value={dateFrom} onChange={e => setDateFrom(e.target.value)} />
                            </div>
                            <div className="col-md-3">
                                <label className="form-label">Дата до</label>
                                <input type="datetime-local" className="form-control"
                                       value={dateTo} onChange={e => setDateTo(e.target.value)} />
                            </div>
                            <div className="col-md-3">
                                <label className="form-label">Тип завдання</label>
                                        <select className="form-select" value={assignmentType} onChange={e => setAssignmentType(e.target.value)}>
                                            {assignmentTypes.map(t => (
                                                <option key={t.Value} value={t.Value}>{t.Text}</option>
                                            ))}
                                        </select>
                            </div>
                            <div className="col-md-3">
                                <label className="form-label">Початок відповіді</label>
                                <input type="text" className="form-control" placeholder="наприклад: Так"
                                       value={answerPrefix} onChange={e => setAnswerPrefix(e.target.value)} />
                            </div>
                            <div className="col-md-3">
                                <label className="form-label">Кінець відповіді</label>
                                <input type="text" className="form-control" placeholder="наприклад: !"
                                       value={answerSuffix} onChange={e => setAnswerSuffix(e.target.value)} />
                            </div>
                            <div className="col-md-9">
                                <label className="form-label">Курси (Ctrl+Click)</label>
                                    <select multiple className="form-select" size="5" value={selectedCourses} onChange={handleCourseChange}>
                                        {courses.map(c => (
                                            <option key={c.Value} value={c.Value}>{c.Text}</option>
                                        ))}
                                    </select>
                            </div>
                            <div className="col-md-3 align-self-end">
                                <button type="submit" className="btn btn-success w-100" disabled={loading}>
                                    {loading ? 'Пошук...' : 'Знайти'}
                                </button>
                            </div>
                        </div>
                    </form>

                    {loading ? (
                        <div className="text-center my-5">
                            <div className="spinner-border text-primary" role="status">
                                <span className="visually-hidden">Завантаження...</span>
                            </div>
                        </div>
                    ) : (
                        <>
                            <h4 className="mb-3">Знайдено: {totalCount} записів</h4>
                            {results.length === 0 ? (
                                <div className="alert alert-info">Записів не знайдено.</div>
                            ) : (
                                <div className="table-responsive">
                                    <table className="table table-bordered table-striped table-hover">
                                        <thead className="table-light">
                                            <tr>
                                                <th>ID</th>
                                                <th>Курс</th>
                                                <th>Модуль</th>
                                                <th>Завдання</th>
                                                <th>Відповідь</th>
                                                <th>Правильно</th>
                                                <th>Оцінено</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {results.map(r => (
                                                <tr key={r.submissionId}>
                                                    <td>{r.submissionId}</td>
                                                    <td>{r.courseTitle}</td>
                                                    <td>{r.moduleTitle}</td>
                                                    <td>{r.assignmentTitle}</td>
                                                    <td>{r.answerText || '-'}</td>
                                                    <td>
                                                        {r.isCorrect === true && <span className="text-success fw-bold">Так</span>}
                                                        {r.isCorrect === false && <span className="text-danger fw-bold">Ні</span>}
                                                        {r.isCorrect == null && '-'}
                                                    </td>
                                                    <td>{r.gradedAt ? new Date(r.gradedAt).toLocaleString('uk-UA') : '-'}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </>
                    )}
                </div>
            );
        }

        // Дані з C# → JS
        const courses = @Html.Raw(JsonSerializer.Serialize(ViewBag.Courses));
        const assignmentTypes = @Html.Raw(JsonSerializer.Serialize(ViewBag.AssignmentTypes));
        const initialModel = @Html.Raw(JsonSerializer.Serialize(Model));

        // Запускаємо React
        ReactDOM.createRoot(document.getElementById('searchApp'))
            .render(<SubmissionSearch
                initialModel={initialModel}
                courses={courses}
                assignmentTypes={assignmentTypes}
            />);
    </script>
}