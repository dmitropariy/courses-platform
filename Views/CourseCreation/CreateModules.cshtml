@model courses_platform.Models.Course

@{
    ViewData["Title"] = "Створення модулів";
}

<h2 class="mb-4">Прекрасно! Створимо модулі для курсу: <strong>@Model.Title</strong></h2>

<!-- ---------- Додавання нового модуля ---------- -->
<div class="card mb-4 p-3 shadow-sm">
    <h4>Додати новий модуль</h4>
    <div class="mb-2">
        <input type="text" id="moduleTitle" class="form-control" placeholder="Назва модуля" />
    </div>
    <div class="mb-2">
        <input type="text" id="moduleDescription" class="form-control" placeholder="Опис модуля" />
    </div>
    <button id="addModuleBtn" class="btn btn-success">Додати модуль</button>
</div>

<!-- ---------- Список модулів ---------- -->
<div id="modulesList">
    @foreach (var m in Model.Modules.OrderBy(x => x.OrderNumber))
    {
        <div class="card mb-3 shadow-sm p-3" data-module-id="@m.ModuleId">
            <h5>@m.OrderNumber - @m.Title</h5>
            <p>@m.ModuleDescription</p>

            <!-- ---------- Додавання уроку ---------- -->
            <div class="mb-3">
                <h6>Додати урок</h6>
                <input type="text" class="lessonTitle form-control mb-2" placeholder="Назва уроку" />
                <input type="text" class="lessonDescription form-control mb-2" placeholder="Опис уроку" />
                <button class="addLessonBtn btn btn-primary">Додати урок</button>
            </div>

            <!-- ---------- Список уроків ---------- -->
            <div class="lessons" id="lessons-@m.ModuleId">
                @foreach (var l in m.Lessons.OrderBy(x => x.OrderNumber))
                {
                    <div class="border p-2 mb-2 rounded bg-light">
                        <p><strong>@l.OrderNumber - @l.Title</strong></p>
                        <p>@l.LessonDescription</p>
                        <form action="/CourseCreation/CreateLessonContentBlocks" method="get">
                            <input type="hidden" name="lessonId" value="@l.LessonId" />
                            <button type="submit" class="btn btn-secondary btn-sm">Заповнити матеріал уроку</button>
                        </form>
                    </div>
                }
            </div>

            <!-- ---------- Редагування тестового завдання ---------- -->
            <div>
                <form action="/CourseCreation/CreateModuleAssignments" method="get">
                    <input type="hidden" name="moduleId" value="@m.ModuleId" />
                    <button type="submit" class="btn btn-success btn-sm mt-2">Редагувати тестове завдання</button>
                </form>
            </div>
        </div>
    }
</div>

<!-- ---------- Надіслати курс на публікацію ---------- -->
<div class="mt-4">
    <form action="/CourseCreation/SubmitCourse" method="post">
        <input type="hidden" name="courseId" value="@Model.CourseId" />
        <button type="submit" class="btn btn-success btn-lg">Надіслати заявку на публікацію курсу</button>
    </form>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(function () {

            // ---------- Додавання модуля ----------
            $('#addModuleBtn').click(function () {
                var title = $('#moduleTitle').val();
                var description = $('#moduleDescription').val();
                var courseId = @Model.CourseId;

                $.post('@Url.Action("AddModule", "CourseCreation")',
                    { courseId: courseId, title: title, description: description },
                    function (data) {
                        if (data.success) {
                            $('#modulesList').append(
                                `<div class="card mb-3 shadow-sm p-3" data-module-id="${data.moduleId}">
                                            <h5>${data.orderNumber} - ${data.title}</h5>
                                            <p>${data.description}</p>
                                            <div class="mb-3">
                                                <h6>Додати урок</h6>
                                                <input type="text" class="lessonTitle form-control mb-2" placeholder="Назва уроку" />
                                                <input type="text" class="lessonDescription form-control mb-2" placeholder="Опис уроку" />
                                                <button class="addLessonBtn btn btn-primary">Додати урок</button>
                                            </div>
                                            <div class="lessons" id="lessons-${data.moduleId}"></div>
                                            <div>
                                                <form action="/CourseCreation/CreateModuleAssignments" method="get">
                                                    <input type="hidden" name="moduleId" value="${data.moduleId}" />
                                                    <button type="submit" class="btn btn-success btn-sm mt-2">Редагувати тестове завдання</button>
                                                </form>
                                            </div>
                                        </div>`
                            );
                            $('#moduleTitle').val('');
                            $('#moduleDescription').val('');
                        }
                    });
            });

            // ---------- Додавання уроку ----------
            $(document).on('click', '.addLessonBtn', function () {
                var parentCard = $(this).closest('.card');
                var moduleId = parentCard.data('module-id');
                var title = parentCard.find('.lessonTitle').val();
                var description = parentCard.find('.lessonDescription').val();

                $.post('@Url.Action("AddLesson", "CourseCreation")',
                    { moduleId: moduleId, title: title, lessonDescription: description },
                    function (data) {
                        if (data.success) {
                            parentCard.find('.lessons').append(`
                                        <div class="border p-2 mb-2 rounded bg-light">
                                            <p><strong>${data.orderNumber} - ${data.title}</strong></p>
                                            <p>${data.description}</p>
                                            <form action="/CourseCreation/CreateLessonContentBlocks" method="get">
                                                <input type="hidden" name="lessonId" value="${data.lessonId}" />
                                                <button type="submit" class="btn btn-secondary btn-sm">Заповнити матеріал уроку</button>
                                            </form>
                                        </div>`
                            );

                            parentCard.find('.lessonTitle').val('');
                            parentCard.find('.lessonDescription').val('');
                        }
                    });
            });

        });
    </script>
}
