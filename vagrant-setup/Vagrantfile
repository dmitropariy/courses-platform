Vagrant.configure("2") do |config|
  config.vm.box = "ubuntu/jammy64"
  
  config.vm.network "forwarded_port", guest: 5000, host: 5000
  
  config.vm.provider "virtualbox" do |vb|
    vb.gui = true
    vb.memory = "4096"
    vb.cpus = 2
  end
  
  config.vm.provision "shell", inline: <<-SHELL
    apt-get update
    
    apt-get install -y wget apt-transport-https software-properties-common git
    
    wget https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O packages-microsoft-prod.deb
    dpkg -i packages-microsoft-prod.deb
    rm packages-microsoft-prod.deb
    
    apt-get update
    apt-get install -y dotnet-sdk-8.0
    
    echo "Installing SQL Server..."
    
    wget -qO- https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
    add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/22.04/mssql-server-2022.list)"
    apt-get update
    apt-get install -y mssql-server
    
    export MSSQL_SA_PASSWORD='YourStrong@Passw0rd123'
    export ACCEPT_EULA='Y'
    export MSSQL_PID='Developer'
    /opt/mssql/bin/mssql-conf setup accept-eula
    
    systemctl status mssql-server --no-pager
    
    curl https://packages.microsoft.com/config/ubuntu/22.04/prod.list > /etc/apt/sources.list.d/mssql-release.list
    apt-get update
    ACCEPT_EULA=Y apt-get install -y mssql-tools unixodbc-dev
    echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> /home/vagrant/.bashrc
    
    sleep 10
    
    /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P 'YourStrong@Passw0rd123' -Q "CREATE DATABASE CoursesPlatformDB;"
    
    echo "SQL Server installed!"

    cd /home/vagrant
    git clone https://github.com/dmitropariy/courses-platform.git app
    chown -R vagrant:vagrant app
    
    cd app
    git checkout dev

    cat > appsettings.Production.json <<'EOF'
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=CoursesPlatformDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True;"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  }
}
EOF
    
    su - vagrant -c "dotnet tool install --global dotnet-ef"

    echo 'export PATH="$PATH:/home/vagrant/.dotnet/tools"' >> /home/vagrant/.bashrc
    
    export PATH="$PATH:/home/vagrant/.dotnet/tools"

    su - vagrant -c "cd /home/vagrant/app && dotnet restore"
    
    su - vagrant -c "cd /home/vagrant/app && dotnet-ef database update || echo 'Migrations not found or are already used'"
    
    su - vagrant -c "cd /home/vagrant/app && dotnet build"
    
    cat > /etc/systemd/system/dotnetapp.service <<'EOF'
[Unit]
Description=.NET Application
After=network.target

[Service]
Type=simple
User=vagrant
WorkingDirectory=/home/vagrant/app
ExecStart=/usr/bin/dotnet run --project /home/vagrant/app/courses-platform.csproj --urls "http://0.0.0.0:5000" --environment Production
Restart=always
RestartSec=10
Environment=ASPNETCORE_ENVIRONMENT=Production
Environment="DOTNET_ENVIRONMENT=Production"
StandardOutput=journal
StandardError=journal
SyslogIdentifier=dotnetapp

[Install]
WantedBy=multi-user.target
EOF
    
    systemctl daemon-reload
    systemctl enable dotnetapp
    systemctl start dotnetapp
    
    echo "================================"
    echo ".NET project installed!"
    echo "================================"
    echo "Check status: sudo systemctl status dotnetapp"
    echo "Logs: sudo journalctl -u dotnetapp -f"
    echo "================================"
  SHELL
end